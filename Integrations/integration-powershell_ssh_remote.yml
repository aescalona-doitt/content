commonfields:
  id: PowerShell Remoting Over SSH
  version: -1
name: PowerShell Remoting Over SSH
display: PowerShell Remoting Over SSH
category: Utilities
image: data:image/png;base64,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
description: |-
  Use this integration in order to remote into another machine (windows/linux) using SSH, requires PowerShell core on both ends.
  Installation steps needed on target machine can be found in Microsoft's official documentation:
  https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/ssh-remoting-in-powershell-core?view=powershell-6
detaileddescription: Username and password are both associated with the user in the
  target machine which are used to logged in to it.
configuration:
- display: Domain/IP
  name: hostname
  defaultvalue: subdomain.example.com
  type: 0
  required: true
  additionalinfo: Domain or IP of target machine
- display: Username
  name: credentials
  defaultvalue: ""
  type: 9
  required: true
  additionalinfo: User name in target machine
script:
  script: |-
    $global:HOSTNAME = $demisto.Params().hostname
    $global:USERNAME = $demisto.Params().credentials.identifier
    $global:PASSWORD = $demisto.Params().credentials.password

    function CreateSession ()
    {
        <#
        .Description
        Creates a session to target machine using hostname, username and password
        #>
        $SecurePassword = ConvertTo-SecureString -AsPlainText -Force -String $global:PASSWORD
        $Creds = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList $global:USERNAME,$SecurePassword
        $Session = New-PSSession -ComputernName $global:HOSTNAME -Credential $Creds
        return $Session
    }

    function InvokeCommand ($Command)
    {
        <#
        .Description
        Runs invoke-command on existing session.
        .Example
        Get-Process powershell
        #>
        $Title = "Result for PowerShell Remote SSH Command: $Command `n"
        $Session = CreateSession
        $Result = Invoke-Command $Session -ScriptBlock { $Command }

        $EntryContext = [PSCustomObject]@{Command = $Command;Result = $Result}
        $Context = [PSCustomObject]@{
            PowerShellSSH = [PSCustomObject]@{Query=$EntryContext}
        }
        $Contents = $Title + $Result

        $DemistoResult = @{
            Type = 1;
            ContentsFormat = "json";
            Contents = $Contents;
            EntryContext = $Context;
            ReadableContentsFormat = "markdown";
            HumanReadable = $Contents
        }
        return $DemistoResult
    }

    $demisto.Info("Current command is: " + $demisto.GetCommand())

    switch -Exact ($demisto.GetCommand())
    {
        'test-module' {
            $TestConnection = InvokeCommand('$PSVersionTable')
            $demisto.Results($TestConnection); Break
        }
        'pwsh-remoting-query' {
            $Command = $demisto.Args().command
            $RunCommand = InvokeCommand($Command)
            $demisto.Results($RunCommand); Break
        }
        Default {
            $demisto.Error('Unsupported command was entered.')
        }
    }
  type: powershell
  commands:
  - name: pwsh-remoting-query
    arguments:
    - name: command
      required: true
      description: PowerShell command (can be single or multiple in order of execution)
        to run on the target machine
      isArray: true
    outputs:
    - contextPath: PowerShellSSH.Query
      description: Object that contains data about the response of a command run in
        target machine
      type: unknown
    - contextPath: PowerShellSSH.Query.Result
      description: The result of the command run from target machine
      type: string
    - contextPath: PowerShellSSH.Query.Command
      description: The command sent to target machine, used as ID of that query
      type: string
    description: Remote to target machine which has powershell core installed on it
      and is set up for remoting
    execution: true
  dockerimage: demisto/powershell:6.2.3.5563
  runonce: false
tests:
- No test